@model ClusterMergeViewModel
@{
    ViewBag.ViewTitle = Labels.viewTitle_ClusterMerge;
    ViewBag.LayoutView = LayoutPage.ContentOnly;
}

@Html.Partial("_ValidationSummaryOuter")
   
<section id="errorPanel" class="alert alert-warning" style="">
    <header class="alert-heading">
        <h3 class="alert-title">@Labels.Warning</h3>
        <p> @Labels.BackupData </p>
    </header>
</section>

@* Cluster select drop down *@

@using (Html.BeginForm("AjaxMergeClusters", "Support", FormMethod.Post, new { @class = "form-horizontal", @id = "MergeClusterForm"}))
{
    <div class="row">
        <div class="col-sm-5">
            @Html.HifisEditorFor(model => model.FromClusterID, ViewBag.FromClusterList as SelectList, null, new { @class = "type-required" })
        </div>

        <div class="col-sm-5 col-sm-offset-1">
            @Html.HifisEditorFor(model => model.ToClusterID, ViewBag.ToClusterList as SelectList, null, new { @class = "type-required" })
        </div>
    </div>
    
    <div class="clearfix"></div>
    <div class="col-sm-5">
        @Html.HifisEditorFor(m => m.MaintainClusterYN, "YesNo")
    </div>
    <div class="clearfix"></div>

}

<div class="row" style="padding-bottom:10px;">
    <div class="col-sm-10 col-sm-offset-1 hid">
        <div class="row">
            <div class="col-sm-4 col-sm-offset-4 text-center ">
                <button id="mergeButton" type="submit" class="forwardButton btn-primary">@Labels.Merge</button>
            </div>
        </div>
    </div>
</div>

@* DataTables *@
<div class="col-sm-6">
    <div style="overflow:hidden;">
        <div style="overflow:hidden; max-height:600px; width:auto;">
            <div id="innerListWrapper" class="table-responsive">
                <table id="ClusterOrgTable" class="wb-tables table table-striped table-hover" data-wb-tables='{ "bFilter": false, "bInfo": false,"columns": [
                                                            { "width": "100%", "data": "serviceProvider"}
                                                        ],
                                                        "processing": true,
                                                        "order": [ [0, "desc"] ]}'>
                    <thead>
                        <tr>
                            <th>@Labels.ServiceProviders</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="col-sm-6">
    <div style="overflow:hidden;">
        <div style="overflow:hidden; max-height:600px; width:auto;">
            <div id="innerListWrapper2" class="table-responsive">
                <table id="ClusterOrgTable2" class="wb-tables table table-striped table-hover" data-wb-tables='{ "bFilter": false, "bInfo": false,"columns": [
                                                            { "width": "100%", "data": "serviceProvider"}
                                                        ],
                                                        "processing": true,
                                                        "order": [ [0, "desc"] ]}'>
                    <thead>
                        <tr>
                            <th>@Labels.ServiceProviders</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
                     
<div class="clearfix" />
    @Html.ActionLink(Labels.Back, "Edit", "ApplicationSettings", null, new { @class = "prevButton", alt=Labels.Back, aria_label = Labels.Back, @role = "button" })

<div id="dialog-confirm-merge" class="modal mrgn-tp-20">
    <div class="modal-dialog whiteBackground">
        <div id="ConfirmMerge" class="modal-content">
            <div class="modal-header alert alert-warning">
                <button type="button" id="modalXButton_ClusterMerge" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h2 class="modal-title">@Labels.Warning</h2>
            </div>
            <div class="modal-body">
                <p>@Labels.ConfirmClusterMerge</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="modalMergeCloseButton" class="btn btn-default" data-dismiss="modal">@Labels.Close</button>
                <button type="button" id="modalMergeSaveButton" class="btn btn-primary">@Labels.Merge</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- HERE BE THE JAVASCRIPT -->
@using (Html.BeginScriptContext())
{ 
    Html.AddScriptBlock(
        @<script type="text/javascript">

            $('#FromClusterID').on('change', function (e) {
                if ($('#FromClusterID').val()) {
                    $('#ClusterOrgTable').DataTable().ajax.url('@Url.Content("~/Support/OrgListbyClusterJson/?ClusterID=")' + $("#FromClusterID").val()).load(null, false);
                }
                $('#ClusterOrgTable').DataTable().clear().draw();

                //this will prevent the user from selecting the same cluster to merge data to/from
                $("#ToClusterID option[value!='" + $('#FromClusterID').val() + "']").prop('disabled', false);
                $("#ToClusterID option[value='" + $('#FromClusterID').val() + "']").prop('disabled', true);

            });

            $('#FromClusterID').on('select2:unselect', function (e) {
                $('#FromClusterID').val(null).trigger('change');
            });

            $('#ToClusterID').on('change', function (e) {
                if ($('#ToClusterID').val()) {
                    $('#ClusterOrgTable2').DataTable().ajax.url('@Url.Content("~/Support/OrgListbyClusterJson/?ClusterID=")' + $("#ToClusterID").val()).load(null, false);
                }
                $('#ClusterOrgTable2').DataTable().clear().draw();

                $("#FromClusterID option[value!='" + $('#ToClusterID').val() + "']").prop('disabled', false);
                $("#FromClusterID option[value='" + $('#ToClusterID').val() + "']").prop('disabled', true);

            });

            $('#ToClusterID').on('select2:unselect', function (e) {
                $('#ToClusterID').val(null).trigger('change');
            });

            $('#mergeButton').on('click', function (e) {
                if ($('#MergeClusterForm').valid()) {
                    $("#dialog-confirm-merge").modal('toggle');
                } 
            });

            $('#modalMergeSaveButton').on('click', function (e) {
                var FromID = $('#FromClusterID').val();
                var ToID = $('#ToClusterID').val();
                var KeepYN = ($('#MaintainClusterYN').bootstrapSwitch('state') == true);

                @Html.Partial("_Ajax", new AjaxViewModel()
                {
                            Url = "'" + Url.Content("~/Support/AjaxMergeClusters") + "'",
                            Data = "{FromClusterID: FromID, ToClusterID: ToID, MaintainClusterYN: KeepYN}",
                            OnSuccess = "displayNotification(\"success\", \"\", \"<p>" + Labels.Success + "</p>\"); updateClusters(FromID, KeepYN);",
                            OnFailure = "displayNotification(\"error\", \"\", \"<p>" + Labels.Error + "</p>\");",
                            OnComplete = "$('#dialog-confirm-merge').modal('toggle');",
                            Type="POST"
                });
            });

            function updateClusters(FromID, KeepYN) {
                $("#FromClusterID").val('').trigger('change');
                if (!KeepYN) {
                    $("#FromClusterID option[value='" + FromID + "']").remove();
                    $("#ToClusterID option[value='" + FromID + "']").remove();
                }
                $('#ToClusterID').trigger('change');
            }
        </script>
);}