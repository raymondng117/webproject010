@model GroupActivityViewModel


<div>
    @if (ViewBag.Display == false && (Model.OwnerOrganizationID == null || Model.OwnerOrganizationID == ViewBag.CurrentOrgID))
    {
        <table>
            <tr>
                <td>@Html.HifisMultiAutocompleteFor(model => model.ClientIDs
                            , Url.Content("~/ClientTombstone/AjaxGetClientList")
                            , new AutocompleteViewModelOptions() { OnSelect = "checkSelection();" }
                            , null, String.Format("<a id=\"clientButton\" class=\"\" title=\"{0}\" aria-controls='Add_Clients' role='button'><span class='glyphicon glyphicon-plus-sign'></span></a>", Labels.Add))</td>
                <td>
                    @Html.HiddenFor(model => model.AnonymousAttendees, new { id = "hdnAnons"})
                    @Html.HifisEditorFor(model => model.AnonymousAttendees, null, new { autocomplete = "off" }, false, String.Format("<a id=\"anonymousButton\" class=\"\" title=\"{0}\" aria-controls='Add_Anonymous' role='button'><span class='glyphicon glyphicon-floppy-disk'></span></a>", Labels.Add))
                </td>
             </tr>
        </table>
    }
    else
    {
        @Html.HifisDisplayFor(model => model.AnonymousAttendees)
    }
</div>

<table id="clientsTable" class="wb-tables table table-striped table-hover" 
    data-wb-tables='{ "columns": [
                        { "width": "40%", "data": "name"},
                        { "width": "15%", "data": "gender"},
                        { "width": "20%", "data": "dob"},
                        { "width": "5%", "data": "age"},
                        { "width": "10%", "data": "attend"},
                        { "width": "10%", "data": "remove"}
                    ],
                    "order": [ [0, "desc"] ],
                    "ajax": "@Url.Content("~/GroupActivities/ClientListJson?id=" + Model.GroupActivityID + "&display=" + ViewBag.Display )"                         
                }'>
    <thead>
        <tr>
            <th class="align-text-center">@Labels.FullName</th>
            <th class="align-text-center">@Labels.Gender</th>
            <th class="align-text-center">@Labels.DOB</th>
            <th class="align-text-center">@Labels.Age</th>
            <th class="align-text-center">@Labels.Attended</th>
            <th class="align-text-center">@Labels.Remove</th>
        </tr>
    </thead>
    <tbody class="align-text-center">
    </tbody>
</table>

@if (ViewBag.Display == false && (Model.OwnerOrganizationID == null || Model.OwnerOrganizationID == ViewBag.CurrentOrgID))
{
    <div style="padding-bottom: 40px;">
        <table>
            <tr>
                <td>
                    <button type="button" id="allAttendedButton" class="manageButton">@Labels.AllAttended</button>
                </td>
                <td>
                    <button type="button" id="noneAttendedButton" class="manageButton">@Labels.NoneAttended</button>
                </td>
            </tr>
        </table>
    </div>
}

<!-- JavaScript -->
@using (Html.BeginScriptContext())
{
    Html.AddScriptBlock(
        @<script type="text/javascript">
             var table = $('#clientsTable');

             //prevents non numeric input.
             $('#AnonymousAttendees').on('keypress', function (e) {
                 return e.metaKey || // cmd/ctrl
                   e.which <= 0 || // arrow keys
                   e.which == 8 || // delete key
                   /[0-9]/.test(String.fromCharCode(e.which)); // numbers
             }).on('change', function (e) {
                 if (parseInt($(this).val()) > '@short.MaxValue')
                     $(this).val(@short.MaxValue)
    }).attr({ min: 0, max: '@short.MaxValue' });

             //sets the status of the checkbox after the initial load of the table
             //
             table.on('draw.dt', function () {
                 $('input[type=checkbox]').each(function () {
                     if ($(this).attr('data-val') == 'False') {
                         $(this).removeAttr('checked');
                     }
                 });
             });

             $(document).on('clientsTable:row:removed', function () {
                 populateClientDemograhpics($('input[id=GroupActivityID]').val());
             });

             //On Success function that displays results to the user, reloads the datatable, and initializes the buttons in the table.
             function defaultAttendeesSaved() {

                 if (window.location.href.indexOf("/Messages/List") != -1) {
                     CheckForNewMessages();
                 }

                 displayNotification('success', '', "<p>@Labels.DefaultDataSavedMessage</p>");

                 table.DataTable().ajax.reload(function () {
                     $('select[id=ClientIDs]').select2("val", "");
                     $('select[id=ClientIDs]').empty();
                     $('input[type=checkbox]').each(function () {
                         if ($(this).attr('data-val') == 'False') {
                             $(this).removeAttr('checked');
                         }
                     });
                 });

                 populateClientDemograhpics($('input[id=GroupActivityID]').val());
             }

             //On Success function that displays results to the user, and reloads the demographics table
             function defaultAnonymousSaved() {

                 if (window.location.href.indexOf("/Messages/List") != -1) {
            isClientRestricted
                     CheckForNewMessages();
                 }

                 displayNotification('success', '', "<p>@Labels.DefaultDataSavedMessage</p>");

                 populateAnonymousDemograhpics($('input[id=GroupActivityID]').val());
             }

             // On failure notification
             function defaultAttendeesFailed() {
                 displayNotification("error", "", "<p>@Labels.FailedToSave</p>");
             }

             //updates the count of anonymous attendees
             $(function () {
                 $("#anonymousButton").on("click", function (e) {
                     var aDiff = parseInt($('#hdnAnons').val()) - parseInt($('#AnonymousAttendees').val());

                     if (aDiff <= 0 || parseInt($('#savedAgeUnknown').val()) >= aDiff && parseInt($('#savedSexUnknown').val()) >= aDiff && parseInt($('#savedAbrUnknown').val()) >= aDiff && parseInt($('#savedDisUnknown').val()) >= aDiff) {

                        $('#hdnAnons').val(parseInt($('#AnonymousAttendees').val()));
                         
                        var anons;
                        var aID;

                        anons = $('#AnonymousAttendees').val();
                        aID = $('input[id=GroupActivityID]').val();

                        @Html.Partial("_Ajax", new AjaxViewModel()
                        {
                            Url = "'" + Url.Content("~/GroupActivities/UpdateAnonymousAttendees") + "'",
                            Data = "{count: anons, activityID: aID}",
                            OnSuccess = "defaultAnonymousSaved()",
                            OnFailure = "defaultAttendeesFailed()",
                            OnComplete = "",
                            Type = "POST"
                        });
                     }
                     else {
                         $('.nav-tabs a[href="#Demographics"]').tab('show')
                         displayNotification("error", "", "<p>@Labels.msgErrorAnonAttendeeCount</p>");
                     }
                });                 
             });

             //Inserts the selected clients from the client multiselect into the group activity
             $(function () {
                 $("#clientButton").on("click", function (e) {

                    var cIDs = [];
                    var aID;

                    aID = $('input[id=GroupActivityID]').val();
                    cIDs = $('select[id=ClientIDs]').val();

                    @Html.Partial("_Ajax", new AjaxViewModel()
                    {
                        Url = "'" + Url.Content("~/GroupActivities/AddClients") + "'",
                        Data = "{clientIDs: cIDs, activityID: aID}",
                        OnSuccess = "defaultAttendeesSaved()",
                        OnFailure = "defaultAttendeesFailed()",
                        OnComplete = "",
                        Type = "POST"
                    });
                 });
             });

             //Sets all clients in the activity to not attended
             $(function () {
                 $("#noneAttendedButton").on("click", function (e) {

                    var aID;

                    aID = $('input[id=GroupActivityID]').val();

                    @Html.Partial("_Ajax", new AjaxViewModel()
                    {
                        Url = "'" + Url.Content("~/GroupActivities/NoneAttended") + "'",
                        Data = "{ activityID: aID}",
                        OnSuccess = "defaultAttendeesSaved()",
                        OnFailure = "defaultAttendeesFailed()",
                        OnComplete = "",
                        Type = "POST"
                    });
                 });
             });
             
             //Sets all clients in the activity to  attended
             $(function () {
                 $("#allAttendedButton").on("click", function (e) {

                    var aID;

                    aID = $('input[id=GroupActivityID]').val();

                    @Html.Partial("_Ajax", new AjaxViewModel()
                    {
                        Url = "'" + Url.Content("~/GroupActivities/AllAttended") + "'",
                        Data = "{ activityID: aID}",
                        OnSuccess = "defaultAttendeesSaved()",
                        OnFailure = "defaultAttendeesFailed()",
                        OnComplete = "",
                        Type = "POST"
                    });
                 });
             });
             //toggles the client's attendence status with the yes/no slider
             $(function () {
                 $(document).on('switchChange.bootstrapSwitch', "input[id=attendedYN]", function () {
                     var remID;
                     var actID;

                     actID = $('input[id=GroupActivityID]').val();
                     attID = $(this).val();

                     toggleAttendence(attID, actID);
                 });
             });

             function toggleAttendence(cid, aid) {

                @Html.Partial("_Ajax", new AjaxViewModel()
                {
                    Url = "'" + Url.Content("~/GroupActivities/ToggleAttendence") + "'",
                    Data = "{clientID: cid, activityID: aid}",
                    OnSuccess = "defaultAttendeesSaved()",
                    OnFailure = "defaultAttendeesFailed()",
                    OnComplete = "",
                    Type = "POST"
                });
             };

             $(function () {
                 $("#clientsTable tbody").on("click", "td.align-text-center", function (e) {
                     var nextTR = $(this).parent("tr").next();
                     
                     if (nextTR.children("td").children(".parent").length < 1) {
                         var nextRow = nextTR.nextUntil().find(".parent").first().parent("td").parent("tr");
                         var rowList = nextTR.nextUntil(nextRow).add(nextTR);

                         if (rowList.length > 1)
                             rowList.stop(true, true).slideToggle("swing");
                     }

                     console.log(nextTR, nextRow, nextRow.prev());
                     e.preventDefault();
                 });                                 
             });

             //checks if the client is already in the group activity when added to the multiselect.
             //if already added they are automatically removed.
             //$("#ClientIDs").on("select2:select", function (e) {
             //    var cID;
             //    var badName = "";
             //    var aID;
             //    cID = $('select[id=ClientIDs]').children('option').last().val();
             //    aID = $('input[id=GroupActivityID]').val();
             //    badName = $('select[id=ClientIDs]').children('option').last().text();
             //    isClientInGroup(cID.toString(), aID.toString(), badName);
            //});
             function checkSelection() {
                 var cID;
                 var badName = "";
                 var aID;
                 cID = $('select[id=ClientIDs]').children('option').last().val();
                 aID = $('input[id=GroupActivityID]').val();
                 badName = $('select[id=ClientIDs]').children('option').last().text();
                 isClientInGroup(cID.toString(), aID.toString(), badName);
             }

             function isClientInGroup(cid, aid, text) {
                 $.ajax({

                     url: "@Url.Action("GetClientStatus", "GroupActivities")",
                     type: "POST",
            data: { "clientID": cid, "activityID": aid },

                 }).done(function (data) {
                     if (data == false) {
                isServiceRestricted(cid, text);
                     } else {
                         displayNotification('error', '', "<p>@Labels.AlreadyRegistered</p>");
                         $("#ClientIDs option[value=" + cid + "]").prop("selected", false).parent().trigger("change");
                         $("#ClientIDs option[value=" + cid + "]").remove();
                         $(".clientButton[data-clientid='" + cid + "']").remove();
                     }
                 });
             };

    /***************************************************************************
    *
    *   This function checks for a service restriction.
    *
    ****************************************************************************/
    function isServiceRestricted(id, text) {

        $.ajax({

            url: "@Url.Action("IsServiceRestrictedAjax", "Master")",
            type: "GET",
            data: { "id": id, "moduleType": "@ServiceRestrictionModules.GroupActivies", "requestDate": ($("#Datestrt").val()) },

        }).done(function (data) {
            if (data) {

                if ("@RightsHelper.HasRight(UserRights.Barred_Override)" === "False") {
                    alert(text + "@Labels.ActiveServiceRestriction");
                    $("#ClientIDs option[value=" + id + "]").prop("selected", false).parent().trigger("change");
                    $("#ClientIDs option[value=" + id + "]").remove();
                    $(".clientButton[data-clientid='" + id + "']").remove();
                } else {
                    alert(text + "@Labels.ActiveServiceRestriction");
                    displayNotification('success', '', "<p>@Labels.ServiceSelected</p>");
                }
            } else if ($(".clientButton[data-clientid='" + id + "']").length == 0){
                $("#clientToolBar").append("<div class=\"clientButton btn btn-primary\" data-clientid=\"" + id
                    + "\"><span class=\"glyphicon glyphicon-user\"></span>&nbsp&nbsp" + text + "</div>");
                displayNotification('success', '', "<p>@Labels.ServiceSelected</p>");
            }

        });

    }


             var cunselecting = false;
             var coldArray = [];

             $('#ClientIDs').on('select2:unselecting', function (e) {
                 if (cunselecting === false) {
                     cunselecting = true;
                     coldArray = $('select[id=ClientIDs]').val();
                 }
             });

             $('#ClientIDs').on('select2:unselect', function (e) {
                 var newArray = [];
                 newArray = $('select[id=ClientIDs]').val();
                 clearOptions("ClientIDs", coldArray, newArray);
                 coldArray = newArray;

                 if (coldArray === null || coldArray.length === 0) {
                     cunselecting = false;
                 }
             });

             //used to remove all select2 options that were deselected
             function clearOptions(selector, oldArray, newArray) {
                 var diff = $(oldArray).not(newArray).get();
                 $("#" + selector + " option[value=" + diff + "]").remove();
             };

             //removes the corresponding client from the group activity
            @*$(function () {
                $(document).on("click", "button[id=removeAttendee]", function () {
                    var remID;
                    var actID;

                    actID = $('input[id=GroupActivityID]').val();
                    remID = $(this).val();

                    removeClient(remID, actID);
                });
            });

             function removeClient(cid, aid) {

                @Html.Partial("_Ajax", new AjaxViewModel()
                 {
                    Url = "'" + Url.Content("~/GroupActivities/RemoveClient") + "'",
                    Data = "{clientID: cid, activityID: aid}",
                    OnSuccess = "defaultAttendeesSaved()",
                    OnFailure = "defaultAttendeesFailed()",
                    OnComplete = "",
                    Type = "POST"
             });
             };*@

         </script>
    );
}
